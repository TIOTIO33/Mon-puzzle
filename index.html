<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon Puzzle Cartoon</title>
  <style>
    body {
      margin: 0;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: linear-gradient(135deg, #FFDEE9 0%, #B5FFFC 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
    }
    h1 {
      margin: 20px;
      color: #333;
      text-shadow: 1px 1px 3px #fff;
    }
    #config {
      margin: 10px;
    }
    #puzzle-board {
      display: grid;
      gap: 2px;
      margin: 15px 0;
      background: #fff;
      border: 3px dashed #333;
      padding: 5px;
      border-radius: 10px;
    }
    .slot {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      background: rgba(200,200,200,0.3);
    }
    #pieces-bar {
      display: flex;
      overflow-x: auto;
      background: rgba(255,255,255,0.8);
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
      border-top: 2px solid #ccc;
    }
    canvas.piece {
      margin-right: 5px;
      cursor: grab;
      border-radius: 8px;
      border: 1px solid #aaa;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<h1>Mon Puzzle Cartoon</h1>

<div id="config">
  <label for="gridSize">Taille du puzzle :</label>
  <select id="gridSize">
    <option value="3">3x3</option>
    <option value="4">4x4</option>
    <option value="5">5x5</option>
    <option value="10">10x10</option>
    <option value="15">15x15</option>
  </select>
  <input type="file" id="imageInput" accept="image/*" />
</div>

<div id="puzzle-board"></div>
<div id="pieces-bar"></div>

<script>
let img = new Image();
const board = document.getElementById('puzzle-board');
const bar = document.getElementById('pieces-bar');
const gridSelect = document.getElementById('gridSize');
const imageInput = document.getElementById('imageInput');

imageInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = evt => {
      img.onload = () => generatePuzzle();
      img.src = evt.target.result;
    };
    reader.readAsDataURL(file);
  }
});

function generatePuzzle() {
  const gridSize = parseInt(gridSelect.value);
  board.innerHTML = '';
  bar.innerHTML = '';
  board.style.gridTemplateColumns = `repeat(${gridSize}, 60px)`;

  let total = gridSize * gridSize;

  for (let i = 0; i < total; i++) {
    let slot = document.createElement('div');
    slot.className = 'slot';
    slot.dataset.index = i;
    slot.ondragover = e => e.preventDefault();
    slot.ondrop = dropPiece;
    board.appendChild(slot);
  }

  for (let i = 0; i < total; i++) {
    let canvas = createPuzzlePiece(i, gridSize);
    canvas.className = 'piece';
    canvas.width = 60;
    canvas.height = 60;
    canvas.draggable = true;
    canvas.dataset.index = i;
    canvas.ondragstart = e => e.dataTransfer.setData('text/plain', i);
    bar.appendChild(canvas);
  }
  shuffleBar();
}

function createPuzzlePiece(index, gridSize) {
  let canvas = document.createElement('canvas');
  let ctx = canvas.getContext('2d');
  let sx = (index % gridSize) * (img.width / gridSize);
  let sy = Math.floor(index / gridSize) * (img.height / gridSize);
  canvas.width = 60;
  canvas.height = 60;

  let shape = new Path2D();
  let bumpSize = 10;

  shape.moveTo(bumpSize, 0);
  shape.lineTo(60 - bumpSize, 0);
  shape.quadraticCurveTo(60, 10, 60 - bumpSize, 20);
  shape.lineTo(60 - bumpSize, 60 - bumpSize);
  shape.quadraticCurveTo(50, 60, 40, 60 - bumpSize);
  shape.lineTo(bumpSize, 60 - bumpSize);
  shape.quadraticCurveTo(0, 50, bumpSize, 40);
  shape.lineTo(bumpSize, bumpSize);
  shape.quadraticCurveTo(10, 0, bumpSize, 0);

  ctx.save();
  ctx.clip(shape);
  ctx.drawImage(img, sx, sy, img.width / gridSize, img.height / gridSize, 0, 0, 60, 60);
  ctx.restore();

  ctx.strokeStyle = "#000";
  ctx.lineWidth = 1;
  ctx.stroke(shape);
  return canvas;
}

function shuffleBar() {
  for (let i = bar.children.length; i >= 0; i--) {
    bar.appendChild(bar.children[Math.random() * i | 0]);
  }
}

function dropPiece(e) {
  let index = e.dataTransfer.getData('text/plain');
  let existing = this.querySelector('canvas');
  if (existing) bar.appendChild(existing);
  let piece = [...bar.children].find(p => p.dataset.index === index);
  if (piece) {
    this.innerHTML = '';
    this.appendChild(piece);
  }
}
</script>

</body>
</html>
