<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon Puzzle Cartoon</title>
  <style>
    body {
      margin: 0;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: linear-gradient(135deg, #FFDEE9 0%, #B5FFFC 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      overflow: hidden;
    }
    h1 {
      margin: 20px;
      color: #333;
      text-shadow: 1px 1px 3px #fff;
    }
    #config {
      margin: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    #puzzle-board {
      display: grid;
      gap: 2px;
      margin: 10px 0;
      background: #fff;
      border: 4px dashed #333;
      padding: 5px;
      border-radius: 15px;
      max-height: 60vh;
      overflow: auto;
    }
    .slot {
      background: #eee;
      width: 60px;
      height: 60px;
      border-radius: 8px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #pieces-bar {
      display: flex;
      overflow-x: auto;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      border-top: 2px solid #ccc;
    }
    .piece {
      width: 60px;
      height: 60px;
      cursor: grab;
      border: 1px solid #ccc;
      margin-right: 5px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.3);
      transition: transform 0.2s ease;
    }
    .piece:active {
      transform: scale(1.1) rotate(2deg);
    }
    #message {
      font-size: 22px;
      color: #4CAF50;
      display: none;
      margin: 10px;
      animation: pop 0.5s ease;
    }
    @keyframes pop {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>

<h1>Mon Puzzle Cartoon</h1>

<div id="config">
  <label for="gridSize">Taille :</label>
  <select id="gridSize">
    <option value="3">3 x 3</option>
    <option value="4">4 x 4</option>
    <option value="5">5 x 5</option>
    <option value="8">8 x 8</option>
    <option value="10">10 x 10</option>
    <option value="15">15 x 15</option>
  </select>
  <input type="file" id="imageInput" accept="image/*" />
</div>

<div id="puzzle-board"></div>
<div id="pieces-bar"></div>
<div id="message">Bravo, Puzzle Complet !</div>

<script>
let img = new Image();
const board = document.getElementById('puzzle-board');
const bar = document.getElementById('pieces-bar');
const gridSelect = document.getElementById('gridSize');
const imageInput = document.getElementById('imageInput');
const message = document.getElementById('message');

imageInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      img.onload = () => generatePuzzle();
      img.src = evt.target.result;
    };
    reader.readAsDataURL(file);
  }
});

function generatePuzzle() {
  const gridSize = parseInt(gridSelect.value);
  board.innerHTML = '';
  bar.innerHTML = '';
  message.style.display = 'none';
  board.style.gridTemplateColumns = `repeat(${gridSize}, 60px)`;

  const total = gridSize * gridSize;
  const pieceSize = 60;
  const edges = [];

  for (let y = 0; y < gridSize; y++) {
    for (let x = 0; x < gridSize; x++) {
      edges.push({
        top: y === 0 ? 0 : -edges[(y-1)*gridSize + x].bottom,
        left: x === 0 ? 0 : -edges[y*gridSize + x -1].right,
        bottom: y === gridSize-1 ? 0 : Math.random() > 0.5 ? 1 : -1,
        right: x === gridSize-1 ? 0 : Math.random() > 0.5 ? 1 : -1,
      });
    }
  }

  for (let i = 0; i < total; i++) {
    let slot = document.createElement('div');
    slot.className = 'slot';
    slot.dataset.index = i;
    slot.ondragover = e => e.preventDefault();
    slot.ondrop = dropPiece;
    board.appendChild(slot);
  }

  for (let i = 0; i < total; i++) {
    const canvas = document.createElement('canvas');
    canvas.width = pieceSize;
    canvas.height = pieceSize;
    const ctx = canvas.getContext('2d');

    const x = i % gridSize;
    const y = Math.floor(i / gridSize);
    const sw = img.width / gridSize;
    const sh = img.height / gridSize;

    drawPuzzleShape(ctx, img, x, y, sw, sh, pieceSize, edges[i]);
    canvas.className = 'piece';
    canvas.draggable = true;
    canvas.dataset.index = i;
    canvas.ondragstart = e => e.dataTransfer.setData('text/plain', i);
    bar.appendChild(canvas);
  }
  shuffleBar();
}

function drawPuzzleShape(ctx, img, px, py, sw, sh, size, edge) {
  ctx.save();
  ctx.beginPath();

  // Haut
  ctx.moveTo(0,0);
  if (edge.top) {
    ctx.lineTo(size * 0.25, 0);
    ctx.bezierCurveTo(size * 0.375, edge.top * -size * 0.2, size * 0.625, edge.top * -size * 0.2, size * 0.75, 0);
  }
  ctx.lineTo(size,0);

  // Droite
  if (edge.right) {
    ctx.lineTo(size, size * 0.25);
    ctx.bezierCurveTo(size + edge.right * size * 0.2, size * 0.375, size + edge.right * size * 0.2, size * 0.625, size, size * 0.75);
  }
  ctx.lineTo(size, size);

  // Bas
  if (edge.bottom) {
    ctx.lineTo(size * 0.75, size);
    ctx.bezierCurveTo(size * 0.625, size + edge.bottom * size * 0.2, size * 0.375, size + edge.bottom * size * 0.2, size * 0.25, size);
  }
  ctx.lineTo(0, size);

  // Gauche
  if (edge.left) {
    ctx.lineTo(0, size * 0.75);
    ctx.bezierCurveTo(edge.left * -size * 0.2, size * 0.625, edge.left * -size * 0.2, size * 0.375, 0, size * 0.25);
  }
  ctx.closePath();
  ctx.clip();

  ctx.drawImage(img, px * sw, py * sh, sw, sh, 0, 0, size, size);
  ctx.restore();
}

function shuffleBar() {
  for (let i = bar.children.length; i >= 0; i--) {
    bar.appendChild(bar.children[Math.random() * i | 0]);
  }
}

function dropPiece(e) {
  let index = e.dataTransfer.getData('text/plain');
  if (parseInt(this.dataset.index) === parseInt(index)) {
    let piece = [...bar.children].find(p => p.dataset.index === index);
    this.innerHTML = '';
    this.appendChild(piece);
    piece.draggable = false;
    piece.style.cursor = 'default';
    checkWin();
  } else {
    alert('Oups ! Mauvaise place. Réessaie !');
  }
}

function checkWin() {
  let correct = 0;
  document.querySelectorAll('.slot').forEach(slot => {
    if (slot.children.length > 0 && slot.children[0].dataset.index === slot.dataset.index) {
      correct++;
    }
  });
  if (correct === document.querySelectorAll('.slot').length) {
    message.style.display = 'block';
  }
}
</script>

</body>
</html>
